name: Update Releases Table

on:
  push: # Cháº¡y khi cÃ³ push
  schedule:
    - cron: '0 0 * * *' # Cháº¡y hÃ ng ngÃ y lÃºc ná»­a Ä‘Ãªm UTC
  workflow_dispatch: # Cho phÃ©p kÃ­ch hoáº¡t thá»§ cÃ´ng
  release: # Cháº¡y khi cÃ³ thay Ä‘á»•i liÃªn quan Ä‘áº¿n release
    types: [created, edited, deleted, published, unpublished] # CÃ¡c hÃ nh Ä‘á»™ng release sáº½ kÃ­ch hoáº¡t

jobs:
  update-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch Releases
        id: fetch-releases
        run: |
          curl -s -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/dvtlive/ZYGISK-AOV-AUTO-UPDATE/releases \
            > releases.json

      - name: Generate Releases Tables for All Languages
        run: |
          # English Table
          echo "#### ğŸ“¦ Releases Table" > releases-table-en.md
          echo "" >> releases-table-en.md
          echo "| Version | Release Date | Download |" >> releases-table-en.md
          echo "|---------|--------------|----------|" >> releases-table-en.md
          jq -r '.[] | select(.draft == false and .prerelease == false) | "| [\(.tag_name)](\(.html_url)) | \(.published_at[0:10]) | [![Download \(.tag_name)](https://img.shields.io/badge/Download-\(.tag_name)-green)](\(.assets[0].browser_download_url)) |"' releases.json >> releases-table-en.md
          echo "" >> releases-table-en.md
          echo "*This table is dynamically generated using GitHub Actions.*" >> releases-table-en.md

          # Vietnamese Table
          echo "#### ğŸ“¦ Báº£ng CÃ¡c Báº£n PhÃ¡t HÃ nh" > releases-table-vi.md
          echo "" >> releases-table-vi.md
          echo "| PhiÃªn báº£n | NgÃ y phÃ¡t hÃ nh | Táº£i xuá»‘ng |" >> releases-table-vi.md
          echo "|-----------|----------------|----------|" >> releases-table-vi.md
          jq -r '.[] | select(.draft == false and .prerelease == false) | "| [\(.tag_name)](\(.html_url)) | \(.published_at[0:10]) | [![Táº£i xuá»‘ng \(.tag_name)](https://img.shields.io/badge/Táº£i_xuá»‘ng-\(.tag_name)-green)](\(.assets[0].browser_download_url)) |"' releases.json >> releases-table-vi.md
          echo "" >> releases-table-vi.md
          echo "*(Báº£ng nÃ y Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng báº±ng GitHub Actions.)*" >> releases-table-vi.md

          # Chinese Table
          echo "#### ğŸ“¦ ç‰ˆæœ¬å‘å¸ƒè¡¨" > releases-table-zh.md
          echo "" >> releases-table-zh.md
          echo "| ç‰ˆæœ¬    | å‘å¸ƒæ—¥æœŸ   | ä¸‹è½½ |" >> releases-table-zh.md
          echo "|---------|------------|------|" >> releases-table-zh.md
          jq -r '.[] | select(.draft == false and .prerelease == false) | "| [\(.tag_name)](\(.html_url)) | \(.published_at[0:10]) | [![ä¸‹è½½ \(.tag_name)](https://img.shields.io/badge/ä¸‹è½½-\(.tag_name)-green)](\(.assets[0].browser_download_url)) |"' releases.json >> releases-table-zh.md
          echo "" >> releases-table-zh.md
          echo "*(æ­¤è¡¨ä½¿ç”¨ GitHub Actions åŠ¨æ€ç”Ÿæˆã€‚)*" >> releases-table-zh.md

      - name: Update README for English
        run: |
          sed -i '/#### ğŸ“¦ Releases Table/,/---/ { /#### ğŸ“¦ Releases Table/ {r releases-table-en.md
          }; d; }' README.md

      - name: Update README for Vietnamese
        run: |
          sed -i '/#### ğŸ“¦ Báº£ng CÃ¡c Báº£n PhÃ¡t HÃ nh/,/---/ { /#### ğŸ“¦ Báº£ng CÃ¡c Báº£n PhÃ¡t HÃ nh/ {r releases-table-vi.md
          }; d; }' README.md

      - name: Update README for Chinese
        run: |
          sed -i '/#### ğŸ“¦ ç‰ˆæœ¬å‘å¸ƒè¡¨/,/---/ { /#### ğŸ“¦ ç‰ˆæœ¬å‘å¸ƒè¡¨/ {r releases-table-zh.md
          }; d; }' README.md
          cat README.md

      - name: Commit Changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add README.md
          git commit -m "Update releases tables for all languages - Triggered by ${GITHUB_EVENT_NAME}" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
